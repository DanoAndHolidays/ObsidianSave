# ==第四题==
---
下面把你这份“Q4：QC-Selective LightGBM + Conformal（改进版）”代码拆成可直接写进论文/报告的方法描述，并逐段解释为什么这样做。为便于对照，我保留了关键变量名（如 `z13`、`gest_week`、`rc_table` 等）。

# 方法总览

目标：以附件数据中女胎样本的非整倍体标注（13/18/21 染色体的“AB 列”）为判定结果，综合 X 染色体及 13/18/21 的 Z 值、GC 含量、读段及相关比例、BMI 等因素，给出女胎异常判定方法。检测有效孕周通常限定在 10–25 周，本方法在该窗口内建模并进行质量控制与可靠性保证。

方法管线包含四层：①字段规整与孕周解析 → ②质控门（QC gate） → ③成本敏感的 LightGBM 二分类器 + 概率校准 → ④分割式 Conformal 预测集（带拒判）与风险-覆盖分析。

---

## 1. 字段规整与孕周解析（Robust I/O）

**做了什么：**

* 通过模糊匹配函数 `find_col` 在原始表头中自动定位关键列：标签列（如“是否异常/非整倍体/AB/label”等）、Z 值（13/18/21/X）、测序质控字段（GC、比对率、唯一比对读段、重复率、过滤率）、母体特征（BMI、年龄）以及孕周列。
* 将孕周文本统一解析为浮点周数（如“12周+3天”“12w+3”→`12+3/7`），得到标准化的 `gest_week`。

**为什么这样做：**
竞赛附件的表头命名存在变体与中英文混排，模糊匹配能提升脚本的鲁棒性；孕周以“周+天”给出，统一成数值周数才能用于数值建模与筛选。附件对字段含义与判定依据有明确说明，本步骤即是把这些信息映射成可用数据结构。

---

## 2. 质控门（QC gate）

**做了什么：**

* 仅保留 `gest_week ∈ [10, 25]` 的样本（`QC_WEEK_MIN, QC_WEEK_MAX`）。
* 对若干测序质量字段（如 GC、比对率、唯一比对读段、重复率、过滤率）做温和的分位裁剪筛选：保留各列 2%–98% 分位区间内的样本（`qclip_mask`），得到通过 QC 的数据子集 `df_qc` 与对应标签 `y_qc`。

**为什么这样做：**

* 10–25 周为题面常用的有效检测窗口，超出范围的样本不具可比性，会引入系统偏差。
* 测序类特征常含极端值（批次问题、运行异常等），温和分位筛选可在不依赖强分布假设的情况下去除异常样本，稳定后续模型。

---

## 3. 特征装配与缺失处理

**做了什么：**

* 采用“存在即用”的策略组装特征列表 `num_feats`：13/18/21/X 的 Z 值、X 浓度（若有）、整体/分染色体 GC、比对率、唯一比对读段、重复率、过滤率、BMI、年龄与 `gest_week`。
* 全部强制转为数值，并用列中位数填补缺失。

**为什么这样做：**

* 题面建议的因素均纳入，兼顾测序质量与母体特征；中位数填补在异质列上更稳健。附件指出 X、13/18/21 的 Z 值与多项质量指标是判定的重要依据，将其作为主特征符合业务先验。

---

## 4. 数据分层切分（避免信息泄漏）

**做了什么：**

* 按标签分层把 QC 后数据切成 **train / calib / test = 6/2/2**；再把训练集切出 20% 做早停验证（`X_tr/X_val`），保证校准集 `calib` 不被提前使用。

**为什么这样做：**

* 我们需要**独立的校准集**用于概率校准与 Conformal 门限估计；把早停验证留在训练子集中可以避免对校准集“偷看”，确保后续覆盖率与误差评估的客观性。

---

## 5. 成本敏感的 LightGBM 分类器

**做了什么：**

* 以二分类 `LGBMClassifier` 为基础学习器，设置适中的树深与叶子数（`max_depth=6, num_leaves=31`）、子采样与列采样（0.8/0.8），并基于训练集中正负样本比设置 `scale_pos_weight`。先在 `X_tr/X_val` 上拟合以得到 `best_iteration_`，再用该迭代数在 `X_tr` 上重训。

**为什么这样做：**

* **LightGBM**在表格型、小至中等规模、特征间存在非线性/交互的任务上表现稳定，且原生支持缺失值与类别非线性切分，训练开销小、可解释性强（可产出特征重要性）。
* 女胎异常往往**类不平衡**，用 `scale_pos_weight` 显式调高正类权重以降低漏判风险，契合医疗场景“宁可多审慎、少漏诊”的代价结构。

---

## 6. 概率校准（Isotonic Regression）

**做了什么：**

* 用**各自独立的校准集 `calib`**上的原始预测概率 `p_cal_raw` 与真实标签 `y_cal` 训练**各向单调**的等分位回归（`IsotonicRegression`），得到校准映射 `iso`，并将其作用于校准集与测试集的概率，得到 `p_cal`、`p_test`。

**为什么这样做：**

* 树模型输出的原始分数常**欠/过度校准**。虽然 Conformal 方法**不要求**概率完美校准，但更接近真实的概率刻度通常能在相同覆盖率下**降低选择性误差**，也便于阈值制定与结果解释。

---

## 7. 分割式 Conformal 预测集 + 拒判机制

**做了什么：**

* 在校准集上定义**非一致性分数**：对于真实标签 $y$，分数为 $1-p_y$（阳性为 $1-p$，阴性为 $p$）；按给定 $\alpha$ 取分位阈值 $q^\*$。
* 对**每个测试样本**，构造其**预测集** $S\subset\{0,1\}$：若类 0 的非一致性 $\le q^\*$ 则 0 ∈ S；若类 1 的非一致性 $\le q^\*$ 则 1 ∈ S。
* 若 $|S|=1$ 则输出该类；否则**拒判**（`-1`）。并统计**覆盖率**（非拒判比例）、**选择性误差**（在非拒判子集上的误差），绘制**风险-覆盖（RC）曲线**。

**为什么这样做：**

* **分割式 Conformal**在**分布无关、有限样本**前提下给出**理论保证**：在 i.i.d. 条件下，非拒判子集的**误判率**可由 $\alpha$ 控制，覆盖率与风险形成可权衡的曲线。
* 医疗判定对**可置信性**要求高，引入**拒判**让模型在不确定时“少做决定”，将困难样本留给人工或二线检测，显著降低误诊风险。
* 代码提供固定 $\alpha$（如 0.10）与**自动选 $\alpha$** 两种模式：后者在满足最低覆盖率（例如 0.90）前提下**最小化选择性误差**，便于业务侧按“产能/时效/风险”确定运行点。

---

## 8. 评估与可视化

**做了什么：**

* 全量层面报告 **ROC-AUC**、**PR-AUC**；在非拒判子集报告**选择性误差**。
* 输出**风险-覆盖表** `rc_table` 与 **RC 曲线**，用于挑选运行点。
* 以 LightGBM 的 `feature_importances_` 绘制**特征重要性 Top-20**，用于规则核查与解释。

**为什么这样做：**

* 医疗稀疏阳性下，PR-AUC 更能反映实际检出能力；RC 曲线帮助管理者在“拒判成本”与“误诊成本”之间做透明权衡；特征重要性可发现“无正增益切分”等潜在数据/建模问题。

---

## 9. 与题目要求的对应关系

* **判定目标**：女胎异常以 13/18/21 的非整倍体为金标准（附件“AB 列”说明）。
* **可用信息**：纳入 X 与 13/18/21 的 Z 值、GC/读段/比对率等测序质量指标，以及 BMI、孕周等母体因素。
* **时点约束**：建模限定在 10–25 周的有效检测窗口，符合题面给出的实际检测区间。以上三点均与题目描述一致。

---

## 10. 实施要点与可改进处

* **类别不平衡**：已用 `scale_pos_weight`；也可结合 focal loss 或样本重采样（注意与 Conformal 的独立性）。
* **校准稳健性**：等分位校准可做 K-折交叉版本以减轻过拟合。
* **运行点选择**：在 RC 曲线上，结合业务侧对“拒判比例”与“漏诊风险”的容忍度，选择 $\alpha$ 或采用自动选取策略。
* **可解释性**：在临床发布层面保留特征重要性与若干典型样本的预测-校准-预测集全过程日志，便于审计。

---

### 一句话总结

这是一条“**先保质控、再稳学习、用校准矫正概率、最后用 Conformal 管住可信度**”的判定流水线：它尊重数据的检测窗口与质量特性，利用 LightGBM 处理表格非线性，借助等分位校准确保概率刻度，再用 Conformal 赋予**可控的风险-覆盖权衡与拒判能力**，使女胎异常判定既“能判准”，又“敢说不”。

# ==第三题==
---
下面把你这份“**男胎 Y 浓度达标时机优化（含 BMI 分层 + 离散时间生存 + 机会约束）**”脚本，改写成可直接放进论文/报告的方法说明，并在每一步给出**为什么这样做**的理由。为便于核对，我保留关键术语（`earliest_week / person-period / hazard h(t) / F(t) / 机会约束 / CART 监督分箱` 等）。

---

# 研究目标与总体思路

**目标**：在合法检测时窗（10–25 周）内，预测“孕周 tt”时**累计达到可检阈值**（默认 Y 浓度 ≥4%\ge 4\%）的概率曲线 F(t)F(t)，并在 **BMI 分层**的人群上，求出使“**组内平均累计达标比例** ≥ptarget\ge p_{\rm target}”（如 90%、95%）的**最早孕周** t\*t^\*，作为首检/复检的推荐时点。

**总体流程**：  
数据规整 → 计算个体首次达标周 → **BMI 的 CART 监督分箱**（建人群层异质性）→ 构造 **person-period** 数据 → 训练**离散时间生存森林**近似区间危险度 h(t)h(t) 并做**概率标定** → 由 h(t)h(t) 累积得到 F(t)F(t) → **机会约束**求各 BMI 组的最优 t\*t^\* → **灵敏度分析**与可视化。

---

## 1) 数据规整与字段映射

- **自动识别列名**：用模糊匹配从原表中定位 ID、孕周、BMI、Y 浓度及可用协变量（年龄、身高、体重、GC、比对率、chr18_z）。
    
- **孕周统一刻度**：将“16w+2 / 16周+2天 / 16.5”等格式解析为**浮点周数**。
    
- **Y 浓度统一刻度**：若为百分数（>1），统一换算为比例（0–1）。
    
- **记录清洗**：仅保留 **Y 非空** 且 **孕周可解析** 的男胎记录；同一孕周多测时取 **Y 的最大值**。
    

**为什么**：

- 表头存在中英混用与别名，模糊匹配可提升鲁棒性；
    
- 时间与阈值比较需要一致的数值刻度；
    
- 对“是否可检测”类目标，“同周取最大”更贴近运营语义（达到即可）。
    

---

## 2) 个体首次达标周 `earliest_week`

- 设阈值 **THRESH=0.04**，对每位孕妇，找到 **Y ≥\ge 4%** 的**最早孕周** `earliest_week`（未达标则为缺失）。
    
- 汇总得到逐孕妇表 `by_mother`（含 ID、BMI、`earliest_week` 及可用协变量）。
    

**为什么**：把“是否可检”转化为**首次事件时间**，为后续**监督分箱**和时间分布统计提供监督信号。

---

## 3) BMI 的 CART 监督分箱（人群异质性）

- 用 **决策树回归（CART）**，以 **BMI** 为自变量、以 **`earliest_week`** 为目标，学习 BMI 的**最优切分点**；限制**最多 3 组**（`MAX_LEAVES_BMI=3`）、**每组事件样本 ≥ 30**（`MIN_LEAF_BMI=30`），得到**可解释的 BMI 组**标签，并将分组回填至逐孕妇表与逐次检测表。
    

**为什么选 CART 而非等距/等频**：

- 监督分箱**面向目标**（最小化组内方差、增大全局差异），可自动发现**非线性阈值效应**；
    
- 叶数与最小叶样本的约束抑制过拟合，使分组在样本有限时更稳定、可复现；
    
- 产出的是**区间规则**，便于临床沟通与执行。
    

---

## 4) person-period 数据构造（离散时间生存）

- 对每位孕妇，按孕周升序把相邻两次随访 [wk,wk+1)[w_k,w_{k+1}) 当作一个**区间**；
    
- 若“**首次达标**”落在右端点 wk+1w_{k+1}，则该区间 **event=1**，否则 **event=0**；未达标者所有区间 **event=0**（右删失思想）；
    
- 为每个区间构建特征：区间**中点** `interval_mid = (w_k+w_{k+1})/2` + 个体层协变量（BMI、年龄、体重、身高、GC、比对率、chr18_z 等）。
    

**为什么**：

- 随访时间不等距、人数记录次数不同，用**离散时间生存**自然处理“首次达标”与**右删失**；
    
- `interval_mid` + 树模型即可逼近“达标风险随孕周变化”的形状。
    

---

## 5) 区间危险度 h(t)h(t) 学习与概率标定

- 以 **随机森林分类器**拟合区间层面的 Pr⁡(event=1∣features)\Pr(\text{event}=1\mid \text{features})，即近似**危险度** h(t)h(t)；
    
- 若样本/分组充足（样本≥50、ID 组≥2、正负例均存在），用 **GroupShuffleSplit**（按孕妇 ID 分组）做训练/验证切分，避免同一孕妇的区间泄漏到验证集；在验证集上用 **isotonic** 做**概率标定**，并报告 **Brier 分**与标定曲线；
    
- 若条件不满足，走**降级路径**（全量训练、不标定），保证流程可运行。
    

**为什么**：

- 随机森林对表格数据稳健，能捕捉非线性/交互而不依赖参数假设；
    
- **按 ID 分组切分**能消除同一人的时间序列泄漏带来的乐观偏差；
    
- **概率标定**增强 h(t)h(t) 的可解释性，使后续由 h(t)h(t) 积累出的 F(t)F(t) 更可信。
    

---

## 6) 由 h(t)h(t) 得到累计达标曲线 F(t)F(t)

- 在网格 t∈[10,25]t\in[10,25]（步长 0.1 周）上，对组内每位个体 ii 计算危险度序列 hi(t)h_i(t)；
    
- 逐点累乘得到**生存函数** Si(t)=∏k≤t(1−hi(tk))S_i(t)=\prod_{k\le t}(1-h_i(t_k))，再得**累计达标概率** Fi(t)=1−Si(t)F_i(t)=1-S_i(t)；
    
- 组内求平均，得到 Fgroup(t)=meani Fi(t)F_{\rm group}(t)=\text{mean}_i\,F_i(t)。
    

**为什么**：这是离散生存框架下的标准关系，**直观刻画**“随孕周推进，达到可检标准的累计比例”。

---

## 7) 机会约束：各 BMI 组的“最优检测孕周” t\*t^\*

- 给定目标覆盖 ptarget∈{0.90,0.95}p_{\rm target}\in\{0.90,0.95\}（分别对应首检/复检），在网格上寻找**最早**满足
    

Fgroup(t) ≥ ptargetF_{\rm group}(t)\ \ge\ p_{\rm target}

的 tt，记为 t\*t^\*。若在 10–25 周内**达不到**目标，则回报末端 Fgroup(25)F_{\rm group}(25) 作为可达上限并提示策略调整。

**为什么**：运营上追求“到此孕周时，**至少**有 ptargetp_{\rm target} 的人已可检”。“取**最早**满足” 等价于在“**时间越晚风险/成本越高**”的设定下**最小化风险**。

---

## 8) 灵敏度分析与可视化

- **灵敏度**：对阈值（3.5%、4.0%、4.5%）和目标覆盖（0.90±0.02）重建 h(t)h(t) 与 t\*t^\*，检查推荐时点的**稳健性**（同步记录验证 Brier 分）。
    
- **可视化**：绘制各 BMI 组的 **Fgroup(t)F_{\rm group}(t) 曲线**及目标横线；绘制“**各组在不同目标下的 t\*t^\***”柱状图，便于直观比较。
    

**为什么**：阈值与 KPI 常受仪器、场景与管理要求影响，灵敏度分析量化“结论对参数设定的敏感度”，为上线口径提供依据。

---

## 9) 工程与鲁棒性设置

- 自动剔除**整列缺失**的特征；训练前对特征与 `event` 做**丢缺**；
    
- **诊断打印**（样本数、组数、正负例计数、特征清单）便于快速定位数据问题；
    
- **降级路径**保证在极端小样本/极端类分布时仍能产出结果（但概率解释性会弱化）。
    

---

## 10) 可复现的关键超参（与实现一致）

- 阈值 `THRESH=0.04`；合法时窗 `WIN_MIN=10, WIN_MAX=25`；网格步长 `GRID_STEP=0.1`；
    
- 目标覆盖 `P_TARGETS=[0.90,0.95]`；BMI 分箱 `MAX_LEAVES_BMI=3, MIN_LEAF_BMI=30`；
    
- 生存森林树数 `N_TREES=500`；随机种子 `RANDOM_STATE=2025`；
    
- 灵敏度：`THRESH_LIST=[0.035,0.04,0.045]`，`P_TARGET_DELTA=0.02`。
    

---

### 一句话总结

本方法把“是否可检”建模为**首次达标的离散时间事件**，用**随机森林**学习“**孕周推进下的达标危险度**”，再转为**累计达标曲线** F(t)F(t)；在 **BMI 监督分箱**的人群上，通过**机会约束**选择“**最早且覆盖达标**”的孕周作为首检/复检推荐，并以**概率标定与灵敏度分析**保证**可解释与稳健**。
# ==第二题==
---
下面把你这份“**按 BMI 监督分箱→给出首检/复检推荐孕周**”脚本，改写成可直接写进论文/报告的方法描述，并逐段解释“**为什么这样做**”。为便于对照，我保留关键名词（如 *earliest\_week*、*CART 分箱*、*p90/p95* 等）。

# 方法目的

在男胎样本中，利用随访（不同孕周）的 **Y 染色体浓度** 记录，确定“**首次达到可用阈值**”（默认 4%）的 **最早孕周** *earliest\_week*。再以 *earliest\_week* 为监督信号，对 **BMI** 做监督式分箱，得到可解释的人群分层；最后在各 BMI 组内给出 **首检**（p90）与 **复检**（p95）推荐孕周作为运营建议。

---

# 数据规整与变量统一

1. **字段自动定位与孕周解析**

* 通过模糊匹配自动找到 ID、孕周、BMI、Y 浓度等列。
* 将 “16w+2 / 16周+2天 / 16.5” 统一解析为**浮点孕周**。

**为什么**：原始表头常有中英混排与别名，模糊匹配可提升鲁棒性；统一孕周刻度是时间分析的前提。

2. **Y 浓度刻度统一与样本筛选**

* 若 Y 值以百分数给出（>1），统一换算为**比例制**（0–1）。
* 仅保留 **Y 非空** 且 **孕周可解析** 的男胎记录；对同一孕周多次测量，取 **Y 的最大值**（与检测“可用性”目标一致）。

**为什么**：阈值判断基于“是否达到可用标准”，取最大值更符合“达到即可”的运营语义；统一刻度避免阈值歧义。

---

# 指标定义：首次达标孕周

* 设阈值 **THRESH = 0.04（4%）**。对每位孕妇的纵向记录，计算 **首次满足 Y ≥ 4%** 的孕周，记为 *earliest\_week*（未达标记 NaN）。
* 汇总成逐孕妇表 *by\_mother*：包含（ID, BMI, earliest\_week）。

**为什么**：把“是否可检测”转化为**首次事件时间**，这是后续做监督分箱与给出时间分位数推荐的基础。

---

# 监督式 BMI 分箱（CART 回归）

* 使用 **决策树回归（CART）**，以 **BMI** 为自变量、以 **earliest\_week** 为目标，学习 **BMI 的最佳切分点**。
* 约束：**最多 4 组**（`MAX_LEAVES=4`）与 **每组≥30 人**（`MIN_LEAF=30`），防止过拟合与不稳定小样本。
* 从树结构提取切分阈值，生成区间边界（-∞, cut1, cut2, …, +∞），据此给出 **BMI\_group\_CART** 标签。

**为什么选择 CART 而不是等频/等距分箱**：

* 监督分箱让切分点服务于“**尽可能解释 earliest\_week 的差异**”，能捕捉 **非线性** 与 **阈值效应**；
* 通过“最大叶数 + 最小叶样本”抑制过拟合，并提升统计稳定性与可复现性；
* 输出为**区间规则**，便于临床与运营沟通（“BMI 在 \[x, y) 这组，建议…周首检”）。

---

# 切分点“圆整”与可解释性增强

* 将模型学得的切分点“**圆整到 0.5**”（`ROUND_STEP=0.5`），保证区间**严格递增**，避免圆整后重叠；用圆整后的边界重算分组（得到 *BMI\_group\_CART\_round*）。

**为什么**：临床/一线更偏好 **简单、整齐** 的规则边界（如 23.5、27.0 周），圆整能减少“边界抖动”对推荐的影响，并提升跨批次使用时的稳健性与沟通成本友好度。

---

# 组内时间分位统计与推荐时点

* 对“**有事件**”（已达标）的个体，在每个 BMI 组内对 *earliest\_week* 计算：样本数、均值/中位数、**p90** 与 **p95**、最小/最大。
* 在报告中将 **p90** 解释为“**首检** 推荐孕周”，**p95** 解释为“**复检** 推荐孕周”。

**为什么用分位数而非均值**：

* 首检/复检决策追求“**覆盖一定比例人群在此时点前已达标**”的把握度，分位数（p90/p95）与运营 KPI（覆盖率/命中率）天然对齐；
* 相比均值，分位数对**长尾与异常值不敏感**，使推荐更稳健。

---

# 对未达标者与全体的处理

* 监督分箱仅用**有事件样本**学习阈值（能有效利用“何时达标”的信息）；
* 但**最终分组**也会覆盖**全体个体**（含未达标者），以便完整输出群体分层与后续扩展分析（如人群结构、资源配置）。

**为什么**：学习阶段需要“有事件”才能学习“时间差异”；而应用阶段需要让分组覆盖全部人群，才能在运营侧落地（排期、容量估算等）。

---

# 关键超参与默认值（与实现一致）

* `THRESH=0.04`：达标阈值（可按仪器/方案调整）。
* `MAX_LEAVES=4, MIN_LEAF=30`：限制树复杂度与每组下限，保证稳定性。
* `ROUND_STEP=0.5`：切分点圆整粒度（可设为 1.0 以进一步简化）。

---

# 结果呈现与落地方式

* **输出 1**：BMI 分组的（圆整后）区间与样本量。
* **输出 2**：各 BMI 组的 *earliest\_week* 统计表，重点报告 **p90（首检）/p95（复检）**。
* **解读**：例如，“BMI∈\[x, y) 组，建议在 **p90 周**安排首检；若未达标，在 **p95 周**安排复检”。

---

# 方法优点与边界

**优点**

* 端到端：从原始随访 → 达标时点 → 监督分箱 → 推荐时点；
* 规则清晰：输出为“BMI 区间 + 推荐孕周（p90/p95）”，便于临床沟通；
* 稳健可复现：叶数/叶大小约束 + 圆整边界，减小偶然性波动。

**边界与改进**

* 若“有事件”样本太少（脚本中阈值 <3 人直接报错），分箱与分位估计都不稳定；可并组或放宽 MIN\_LEAF。
* *earliest\_week* 基于单一阈值（4%），可做 **灵敏度分析**（例如 3.5%、4.5%）检查推荐时点的稳健性。
* 分箱只用 BMI，一般可与年龄/IVF/测序质量等变量**联合分层**，但需注意每组样本量充足。
* 若希望从“何时达标”的**全时间过程**给出覆盖-时间曲线和机会约束最优时点，可进一步采用**离散时间生存建模**（你在 Q2/Q4 中已实现）。

---

**一句话总结**
本方法把“达到可检标准”转成“**首次达标时间**”，用 **CART** 在 **BMI** 上学习能解释时间差异的**最优切分点**，再以 **p90/p95** 给出各 BMI 组的**首检/复检推荐孕周**，实现“**可解释的人群分层 + 可执行的时间策略**”。
